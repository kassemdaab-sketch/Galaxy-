<script>
    let currentEngine = 'google';
    const input = document.getElementById('search-input');
    const logs = document.getElementById('logs');

    function addLog(msg) {
        const div = document.createElement('div');
        div.innerText = `> [${new Date().toLocaleTimeString()}] ${msg}`;
        logs.prepend(div);
    }

    function setEngine(engine, el) {
        currentEngine = engine;
        document.querySelectorAll('.engine-pill').forEach(p => p.classList.remove('active'));
        el.classList.add('active');
        addLog(`ENGINE_SWITCHED: ${engine.toUpperCase()}`);
    }

    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const val = input.value.trim();
            if (!val) return;
            let url = val;
            const isUrl = val.includes('.') && !val.includes(' ');
            if (!isUrl) {
                // TIP: Use DuckDuckGo or Brave to avoid the "Unusual Traffic" error
                const searchPaths = { 
                    google: "https://www.google.com/search?q=", 
                    ddg: "https://duckduckgo.com/?q=", 
                    brave: "https://search.brave.com/search?q=" 
                };
                url = searchPaths[currentEngine] + encodeURIComponent(val);
            } else {
                if (!val.startsWith('http')) url = 'https://' + val;
            }
            launchInTab(url);
        }
    });

    function launchInTab(target) {
        addLog("BYPASSING SECURITY HEADERS...");
        const cloak = document.getElementById('cloak-select').value;
        const identities = {
            docs: { name: "Google Docs", icon: "https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico" },
            classroom: { name: "Classes", icon: "https://ssl.gstatic.com/classroom/favicon.png" },
            canvas: { name: "Dashboard", icon: "https://du11bjcvkw674.cloudfront.net/favicon.ico" }
        };
        
        const activeId = identities[cloak];
        const proxyUrl = `/service?url=${encodeURIComponent(target)}`;

        const win = window.open('about:blank', '_blank');
        if (win) {
            win.document.write(`
                <html>
                <head>
                    <title>${activeId.name}</title>
                    <link rel="icon" href="${activeId.icon}">
                    <style>
                        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; }
                        iframe { width: 100%; height: 100%; border: none; }
                    </style>
                </head>
                <body>
                    <iframe src="${proxyUrl}"></iframe>
                </body>
                </html>
            `);
            win.document.close();
            addLog("UPLINK ESTABLISHED IN CLOAKED TAB");
        } else {
            addLog("ERROR: POPUP BLOCKED. ALLOW POPUPS FOR THIS SITE.");
        }
    }

    // Star animation logic
    const canvas = document.getElementById('stars-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const stars = Array(120).fill().map(() => ({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*1.3 }));
    function draw() { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = "#fff"; stars.forEach(s => { ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill(); }); requestAnimationFrame(draw); }
    draw();
</script>
